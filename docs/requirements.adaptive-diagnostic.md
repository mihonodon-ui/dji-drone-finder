# DJI ドローン診断（動的アキネーター型）要件定義書

## 1. 目的
- ライト層は 3〜5 問で素早くタイプ判定・価格レンジを提示し、早期離脱を防ぐ。
- 産業/専門層には用途・センサー・自動化など詳細条件を基に、最適な構成案と上位/下位候補を提案する。
- カタログ更新や質問追加に柔軟に対応し、ノーコード運用を実現。

## 2. ユーザー分類
- **ライト（趣味/空撮目的）**: 価格感度が高く、機能こだわりは少ない。最小問数で診断完了する。
- **プロ（産業用途）**: 価格・センサー・自動化・SDK などの詳細要件を優先する。追加質問を段階的に提示。
- **ハイブリッド**: 趣味と業務の両立など複数タイプが混在するケース。追加質問で明確化する。

## 3. アーキテクチャ概要
1. **初期判定 (Gateway Questions)**  
   - 利用目的・予算・自動化の有無など 2〜3 問でライト/プロ/ハイブリッドを判別し、出題戦略を決定。
2. **動的質問エンジン (Question Orchestrator)**  
   - 未出題の質問群から、候補タイプのエントロピーを最大化する質問を選択。
   - 条件付き質問（例: 自動化 = Yes のときだけ Dock 質問）を組み込む。
3. **スコアリング/確率更新 (Inference Engine)**  
   - 回答ごとにタイプ別スコア/確率を更新。価格レンジ・センサー要件はハード制約（足切り）として処理。
   - 主要タイプに閾値（例: 80% 以上）を設定し、満たしたら診断終了。
4. **結果生成 (Recommendation Composer)**  
   - primary / secondary タイプ、価格レンジ、推奨モデル、上位/下位候補、コメント、CTA を生成。
   - モード（ライト/プロ）に応じて表示フォーマットを調整。

## 4. データモデル要件
### 4.1 質問メタデータ
`questions.dynamic.json` (新規) に以下を追加。
```json
{
  "id": "q_budget",
  "text": "想定している予算帯は？",
  "category": "price",
  "difficulty": "basic",
  "targetSegments": ["light", "pro"],
  "strategyTags": ["must_ask"],
  "weight": 4,
  "options": [
    { "key": "A", "label": "〜20万円", "scores": { "hobby": 4, "creative": 2 }, "constraints": { "maxPrice": 200000 } },
    { "key": "B", "label": "〜100万円", "scores": { "inspection": 2, "survey": 2, "agri": 2 }, "constraints": { "maxPrice": 1000000 } }
  ]
}
```
- `category`: `purpose | budget | sensor | automation | skill | payload` 等。
- `difficulty`: `basic | advanced | expert`。ライト層は `basic` のみ出題。
- `targetSegments`: 質問を出す対象セグメント。
- `strategyTags`: `must_ask`（必須質問）、`tie_breaker`（同点時優先）、`conditional`（特定回答条件で出題）など。
- `constraints`: 回答による制約（価格レンジ、必須機能など）を宣言的に記述。

### 4.2 カタログ拡張
- `src/data/catalog.models.json` に以下のフィールドを追加。
  - `releaseDate`: 最終更新日。
  - `segments`: 対応セグメント（light/pro/hybrid）。
  - `attributes`: `{ "camera": "4/3 CMOS", "sensor": ["thermal", "RTK"], "automation": ["dock"], "payload": "30kg" }`
  - `priceBand`: `{ "leading": 200000, "lagging": 1000000 }` (表示用レンジと足切り用上限/下限)
- 最新機種反映フロー: DJI 公式リリースを週次で確認→ JSON 更新 → zod スキーマチェック → PR でレビュー。

### 4.3 結果テンプレート
- ライト/プロ別に文言テンプレートを階層化 (`result.templates.json` に `light`/`pro` のセクションを追加)。
- CTA を用途別に複数設定可能（相談・体験会・見積など）。
- 価格メッセージ生成のために `priceBand` と回答の `constraints` を組み合わせる。

## 5. 動的出題ロジック
1. **初期化**: 全タイプのスコアを 0 に設定。価格制約は未確定。質問候補集合を `basic` でフィルタ。
2. **初期判定**: 
   - Q1 目的 → タイプ初期スコア付与。
   - Q2 予算 (must_ask) → 価格足切り (`maxPrice`/`minPrice`) を確定。
   - Q3 自動化/SDK 有無で `pro` モード判定。  
   → `pro` 判定時は `difficulty=advanced` 質問を候補に追加。
3. **質問選択**:
   - エントロピー計算: `H = -Σ p(type) log p(type)`。候補質問ごとに期待情報量を算出。
   - 最高スコアの質問を提示。`strategyTags` がある場合は優先 (`must_ask` > `tie_breaker` > 情報量)。
4. **回答処理**:
   - スコア更新: `score[type] += optionScore * weight`。
   - 制約更新: `constraints` で価格やセンサー条件を適用し、該当しないモデルを候補から除外。
   - タイプ確率算出: 正規化して `p(type)` を得る。
5. **終了判定**:
   - 最高確率タイプが閾値 `>= 0.8` かつ価格制約内にモデルが存在する。
   - 残質問がなくなった、または `maxQuestions` (例: 10問) 到達。
   - ライトモードで `basic` 問 3 問すべて回答済み。
6. **フォールバック**:
   - 閾値未達・価格制約に合うモデルなし → 上位タイプ2つを提示し、価格帯選び直しを促す。

## 6. 結果生成
- **ライト結果**: タイプ + 価格レンジ + メイン/代替機種 + CTA。
- **プロ結果**: 推奨構成（センサー/自動化/開発要件）、上位/下位候補、SKU 別価格帯、導入ヒント。
- **共有URL**: タイプ・質問シード・回答シリアライズを暗号化ハッシュで持たせ、結果再現を可能にする。
- **ログ**: 質問順・回答・候補確率推移・終了理由を GA4/Plausible へ送信。

## 7. UI/UX 要件
- ライト/プロモードを UI 上でも表示し、質問残数や確信度を視覚化。
- 質問スキップは原則不可（must_ask を尊重）。ただしプロ向け補助質問はスキップ可能にし、理由を記録。
- 価格レンジ選択はスライダーも検討。選択後に指標 (`~¥300,000`, `~¥1,000,000`) を即表示。
- 質問カード下部に「現時点の候補タイプ」チップを表示し、進捗感を持たせる。

## 8. 分析/計測
- イベント: `start_dynamic`, `question_shown`, `question_answered`, `mode_switch`, `result_committed`, `share_link_copied`.
- パラメータ: `question_id`, `category`, `mode`, `remaining_types`, `confidence`, `price_band`.
- ダッシュボード: 問題ごとの離脱率、確定までの平均問数、価格レンジ分布、タイプ別成約率。

## 9. 運用フロー
- **質問/カタログ更新手順**:  
  1. 必要に応じて JSON を編集。  
  2. `npm run lint && npm test` でスキーマ検証・スコアロジックの回帰テスト。  
  3. PR 作成 → レビューで diff を確認（質問情報量の変化もレビュー対象）。  
  4. main へマージ後、Vercel で自動デプロイ。
- **権限管理**: JSON 編集は PM/マーケ、ロジックは開発チームがレビュー。
- **将来拡張**: 新タイプ追加時は `catalog.types` + 質問 `scores` + 結果テンプレを更新。特定業種向けのマイクロ質問セットを追加可能。

## 10. 最初の簡易実装プラン（MVP）

### 10.1 質問セット（固定順序）
1. **Q1 目的** (必須)  
   - 選択肢: 趣味・空撮 / 業務（点検/測量/農業） / 研究・開発  
   - 判定: 趣味を選べばライトモード、他はプロモード。
2. **Q2 予算レンジ** (必須)  
   - 選択肢: 〜20万円 / 〜100万円 / 〜300万円 / 1000万円以上  
   - 全モード共通。回答でカタログ候補を足切り。
3. **Q3 ライト向けポイント** (ライト専用)  
   - 選択肢: 画質 / 携帯性 / 自動化  
   - ライトモードはここで診断終了。結果はタイプ + 価格レンジ + メイン/代替機体。
4. **Q4 センサー要件** (プロ専用)  
   - 選択肢: 赤外線必須 / RTK 必須 / LiDAR など先進センサー / 特に不要  
5. **Q5 自動化/Dock** (プロ専用)  
   - 選択肢: 導入済み/予定あり / 検討中 / 不要  
6. **Q6 SDK/開発** (プロ専用)  
   - 選択肢: SDK 必須 / 連携したい / 不要  
7. **Q7 物資運搬/散布** (プロ専用)  
   - 選択肢: 主要業務 / 限定的 / なし  
   - プロは最大 7 問で終了。5〜7問目は条件に応じて順番に出すだけ。

### 10.2 出題ルール（簡易）
- Q1 が趣味の場合 → ライトモード → Q3 までで終了。
- 予算回答に応じて、高額機種を除外してから結果表示。
- プロモードでは Q4〜Q7 を順に表示。回答結果でスコア加算するのみ。
- 自動化が不要の場合でも Q5 は表示。後続のロジックで分岐させる。

### 10.3 スコアリング
- 現行の `scores` + `weight` を使用。ライトモードは Q1〜Q3 のみ反映。
- 価格レンジ回答は `constraints.maxPrice` として扱い、該当外のモデルは結果候補から除外。
- プロモード 完了後に `evaluation.secondary` も表示。

### 10.4 結果表示
- ライト結果: メインモデル + 上位候補 + 価格レンジ表示。
- プロ結果: primary/secondary タイプ、センサー要件まとめ、上位/下位候補、CTA。
- 現行の `result.templates.json` を流用し、価格レンジ文を追加する程度で OK。

### 10.5 実装対象（MVP）
- `questions.dynamic.json` を新規作成、上記 7 問を JSON 化。
- `useDiagnosisEngine`（仮）を作り、モード切り替えと質問インデックス管理を行う。
- STEP1/STEP2 ページの代わりに `/diagnose` を作成し、順番に質問が進む UI を提供。
- 結果ページは既存の `ResultCard`/`CTAButtons` を活用して表示。
- 将来の拡張に備え、質問メタフィールド（`category` など）だけ事前追加しておく。

